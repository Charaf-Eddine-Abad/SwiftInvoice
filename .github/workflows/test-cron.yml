name: Test Cron Job

on:
  # Allow manual triggering from GitHub UI
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of test to run'
        required: true
        default: 'simple'
        type: choice
        options:
        - simple
        - health-check
        - api-test
        - simple-cron

jobs:
  simple-test:
    name: Simple Test
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'simple'
    
    steps:
      - name: Simple Test
        run: |
          echo "üß™ Running simple test..."
          echo "‚úÖ Test completed successfully!"
          echo "üìÖ Current time: $(date)"
          echo "üåç Timezone: $(date +%Z)"
          echo "üìä Random number: $((RANDOM % 100))"
          echo "üéØ Test result: SUCCESS"

  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'health-check'
    
    steps:
      - name: Health Check
        run: |
          echo "üè• Running health check..."
          
          # Test if we can reach the app
          if [ -n "${{ secrets.APP_URL }}" ]; then
            echo "üîó Testing connection to: ${{ secrets.APP_URL }}"
            
            response=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.APP_URL }}" || echo "000")
            
            if [ "$response" = "200" ]; then
              echo "‚úÖ App is responding (HTTP 200)"
            else
              echo "‚ö†Ô∏è App responded with HTTP $response"
            fi
          else
            echo "‚ö†Ô∏è APP_URL secret not set"
          fi
          
          echo "üìÖ Health check completed at: $(date)"

  api-test:
    name: API Test
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'api-test'
    
    steps:
      - name: API Test
        run: |
          echo "üîå Testing API endpoints..."
          
          if [ -n "${{ secrets.APP_URL }}" ] && [ -n "${{ secrets.CRON_SECRET }}" ]; then
            echo "üîó Testing API at: ${{ secrets.APP_URL }}"
            
            # Test health endpoint
            echo "üì° Testing health endpoint..."
            response=$(curl -s -X GET "${{ secrets.APP_URL }}/api/health" \
              -w "HTTPSTATUS:%{http_code}" || echo "HTTPSTATUS:000")
            
            http_code=$(echo $response | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
            body=$(echo $response | sed -e 's/HTTPSTATUS:.*//g')
            
            echo "Health Response: $body"
            echo "Health HTTP Code: $http_code"
            
            if [ $http_code -eq 200 ]; then
              echo "‚úÖ Health check passed"
            else
              echo "‚ö†Ô∏è Health check returned HTTP $http_code"
            fi
            
            # Test cron test endpoint
            echo "üì° Testing cron test endpoint..."
            
            # Ensure APP_URL has https:// and no trailing slash
            APP_URL="${{ secrets.APP_URL }}"
            if [[ ! "$APP_URL" =~ ^https?:// ]]; then
              APP_URL="https://$APP_URL"
            fi
            APP_URL=$(echo "$APP_URL" | sed 's:/*$::')
            
            echo "üîó Using URL: $APP_URL/api/cron/test"
            
            response=$(curl -s -X POST "$APP_URL/api/cron/test" \
              -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
              -H "Content-Type: application/json" \
              -d '{"test": "cron job test", "timestamp": "'$(date -Iseconds)'"}' \
              -w "HTTPSTATUS:%{http_code}" || echo "HTTPSTATUS:000")
            
            http_code=$(echo $response | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
            body=$(echo $response | sed -e 's/HTTPSTATUS:.*//g')
            
            echo "Cron Test Response: $body"
            echo "Cron Test HTTP Code: $http_code"
            
            if [ $http_code -eq 200 ]; then
              echo "‚úÖ Cron test passed"
            else
              echo "‚ö†Ô∏è Cron test returned HTTP $http_code"
            fi
          else
            echo "‚ö†Ô∏è Required secrets not set (APP_URL or CRON_SECRET)"
          fi
          
          echo "üìÖ API test completed at: $(date)"

  simple-cron:
    name: Simple Cron Test
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'simple-cron'
    
    steps:
      - name: Simple Cron Test
        run: |
          echo "üß™ Testing simple cron endpoint..."
          
          if [ -n "${{ secrets.APP_URL }}" ] && [ -n "${{ secrets.CRON_SECRET }}" ]; then
            echo "üîó Testing simple cron at: ${{ secrets.APP_URL }}"
            
            # Test simple cron endpoint
            echo "üì° Testing simple cron endpoint..."
            
            # Ensure APP_URL has https:// and no trailing slash
            APP_URL="${{ secrets.APP_URL }}"
            if [[ ! "$APP_URL" =~ ^https?:// ]]; then
              APP_URL="https://$APP_URL"
            fi
            APP_URL=$(echo "$APP_URL" | sed 's:/*$::')
            
            echo "üîó Using URL: $APP_URL/api/cron/simple-test"
            
            response=$(curl -s -X POST "$APP_URL/api/cron/simple-test" \
              -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
              -H "Content-Type: application/json" \
              -w "HTTPSTATUS:%{http_code}" || echo "HTTPSTATUS:000")
            
            http_code=$(echo $response | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
            body=$(echo $response | sed -e 's/HTTPSTATUS:.*//g')
            
            echo "Simple Cron Response: $body"
            echo "Simple Cron HTTP Code: $http_code"
            
            if [ $http_code -eq 200 ]; then
              echo "‚úÖ Simple cron test passed"
            else
              echo "‚ö†Ô∏è Simple cron test returned HTTP $http_code"
            fi
          else
            echo "‚ö†Ô∏è Required secrets not set (APP_URL or CRON_SECRET)"
          fi
          
          echo "üìÖ Simple cron test completed at: $(date)"
